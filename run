#!/usr/bin/env shelduck_run
set -eux

shelduck import https://raw.githubusercontent.com/legeyda/bobshell/refs/heads/unstable/run.sh
shelduck import https://raw.githubusercontent.com/legeyda/bobshell/refs/heads/unstable/scope.sh
shelduck import https://raw.githubusercontent.com/legeyda/bobshell/refs/heads/unstable/string.sh
shelduck import https://raw.githubusercontent.com/legeyda/bobshell/refs/heads/unstable/install.sh
shelduck import https://raw.githubusercontent.com/legeyda/bobshell/refs/heads/unstable/template.sh
shelduck import https://raw.githubusercontent.com/legeyda/bobshell/refs/heads/unstable/require.sh

on_start() {
	set -x
	: "${RUNWAY_BUILD_TARGET:=./target}"
}

run_docker_build() {
	docker build . -t runway
}

run_clean() {
	rm -rf "$RUNWAY_BUILD_TARGET"
	bobshell_handle_subcommand "$@"
}

run_entrypoint() {
	: "${RUNWAY_PATH:=target/test-checkout}"
	export RUNWAY_PATH
	: "${RUNWAY_REPO=git@github.com:legeyda/bobshell.git}"
	export RUNWAY_REPO
	shelduck_run file://./entrypoint.sh
}

run_test_install() {
	export RUNWAY_INSTALL_NAME=runway
	export RUNWAY_INSTALL_ROOT=./target/test_install
	RUNWAY_INSTALL_SYSTEMCTL=fake_systemctl


	RUNWAY_REPO_URL="git@github.com:legeyda/tailsitter.git"
	RUNWAY_RUN_ENV='x=1; y=2'
	RUNWAY_RUN_COMMAND='./run args from installer'


	run_install
	reset
	
	"$RUNWAY_INSTALL_DESTDIR$RUNWAY_INSTALL_BINDIR/$RUNWAY_INSTALL_NAME"
}

fake_systemctl() {
	printf 'FAKE SYSTEMCTL CALL: systemctl %s\n' "$*"
}

run_install() {
	: "${RUNWAY_INSTALL_NAME:=runway}"
	mkdir -p "$RUNWAY_BUILD_TARGET"

	#
	bobshell_scope_mirror RUNWAY_INSTALL_ BOBSHELL_INSTALL_
	bobshell_install_init
	bobshell_scope_mirror BOBSHELL_INSTALL_ RUNWAY_INSTALL_


	#
	runway_src=$(cat runway)
	runway_src=$(bobshell_replace "$runway_src" "RUNWAY_INSTALL_NAME=runway${bobshell_newline}" "RUNWAY_INSTALL_NAME=$RUNWAY_INSTALL_NAME${bobshell_newline}")
	runway_src=$(bobshell_replace "$runway_src" "RUNWAY_INSTALL_ROOT=${bobshell_newline}" "RUNWAY_INSTALL_ROOT=$RUNWAY_INSTALL_ROOT${bobshell_newline}")
	printf %s "$runway_src" > "$RUNWAY_BUILD_TARGET/$RUNWAY_INSTALL_NAME"
	bobshell_replace "$runway_src" RUNWAY_INSTALL_NAME=runway "RUNWAY_INSTALL_NAME=$RUNWAY_INSTALL_NAME" > "$RUNWAY_BUILD_TARGET/$RUNWAY_INSTALL_NAME"

	bobshell_install_put_executable "file:$RUNWAY_BUILD_TARGET/$RUNWAY_INSTALL_NAME" "$RUNWAY_INSTALL_NAME"

	# 
	bobshell_mustache file:runway.service "file:$RUNWAY_BUILD_TARGET/$RUNWAY_INSTALL_NAME.service"
	bobshell_install_service "file:$RUNWAY_BUILD_TARGET/$RUNWAY_INSTALL_NAME.service" "$RUNWAY_INSTALL_NAME.service"


	(
		target="file:$RUNWAY_BUILD_TARGET/$RUNWAY_INSTALL_NAME-env.sh"
		bobshell_scope_unset RUNWAY_INSTALL_ RUNWAY_BUILD_
		bobshell_scope_env RUNWAY_ "$target"
	)
	bobshell_install_put_config "file:$RUNWAY_BUILD_TARGET/$RUNWAY_INSTALL_NAME-env.sh" env.sh
	

}


shelduck import https://raw.githubusercontent.com/legeyda/bobshell/refs/heads/unstable/entry_point.sh